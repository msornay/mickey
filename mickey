#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: mickey <command> [args]

Commands:
  hire <name>                              Create agent and auth (interactive)
  work [--model <model>] <name> ["<prompt>"] Send task to agent (auto-picks work if no prompt)
  whip [--model <model>]                   Send all agents to work continuously (Ctrl-C to stop)
  sh   <name>                              Shell into agent
  ls                                       List agents
  fire <name>                              Remove agent
  reset                                    Clear patch/ and merge-queue/ (with confirmation)
USAGE
  exit 1
}

[[ $# -eq 0 ]] && usage

cmd=$1; shift

case "$cmd" in
  hire)
    [[ $# -lt 1 ]] && { echo "Usage: mickey hire <name>"; exit 1; }
    docker sandbox create --name "$1" claude ~/src
    docker sandbox run "$1"
    ;;
  work)
    model=""
    if [[ "${1:-}" == "--model" ]]; then
      [[ $# -lt 2 ]] && { echo "Usage: mickey work [--model <model>] <name> [\"<prompt>\"]"; exit 1; }
      shift; model="$1"; shift
    fi
    [[ $# -lt 1 ]] && { echo "Usage: mickey work [--model <model>] <name> [\"<prompt>\"]"; exit 1; }
    name=$1; shift
    prompt="${*:-Follow your default behavior instructions: review unreviewed patches by others, address review feedback on your own patches, or find TODOs in repos and work on them.}"
    if [[ -n "$model" ]]; then
      ANTHROPIC_MODEL="$model" docker sandbox run "$name" -- -p "$prompt"
    else
      docker sandbox run "$name" -- -p "$prompt"
    fi
    ;;
  whip)
    model=""
    if [[ "${1:-}" == "--model" ]]; then
      [[ $# -lt 2 ]] && { echo "Usage: mickey whip [--model <model>]"; exit 1; }
      shift; model="$1"; shift
    fi
    trap 'kill 0; exit 0' INT TERM
    while true; do
      names=$(docker sandbox ls | awk 'NR>1 {print $1}')
      if [[ -z "$names" ]]; then
        echo "No agents found."
        exit 0
      fi
      for name in $names; do
        echo "Sending $name to work..."
        if [[ -n "$model" ]]; then
          "$0" work --model "$model" "$name" &
        else
          "$0" work "$name" &
        fi
      done
      wait
    done
    ;;
  sh)
    [[ $# -lt 1 ]] && { echo "Usage: mickey sh <name>"; exit 1; }
    docker sandbox exec -it "$1" bash
    ;;
  ls)
    docker sandbox ls
    ;;
  fire)
    [[ $# -lt 1 ]] && { echo "Usage: mickey fire <name>"; exit 1; }
    docker sandbox rm "$1"
    ;;
  reset)
    ws="${WORKSPACE_DIR:-$HOME/src}"
    patch_dir="$ws/patch"
    queue_dir="$ws/merge-queue"
    patch_count=$(find "$patch_dir" -maxdepth 1 -type f ! -name '.DS_Store' 2>/dev/null | wc -l)
    queue_count=$(find "$queue_dir" -maxdepth 1 -type f ! -name '.DS_Store' 2>/dev/null | wc -l)
    echo "This will delete:"
    echo "  $patch_count file(s) in $patch_dir"
    echo "  $queue_count file(s) in $queue_dir"
    printf "Continue? [y/N] "
    read -r answer
    [[ "$answer" =~ ^[Yy]$ ]] || { echo "Aborted."; exit 1; }
    find "$patch_dir" -maxdepth 1 -type f ! -name '.DS_Store' -delete 2>/dev/null || true
    find "$queue_dir" -maxdepth 1 -type f ! -name '.DS_Store' -delete 2>/dev/null || true
    echo "Done."
    ;;
  *)
    usage
    ;;
esac
