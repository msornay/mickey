#!/usr/bin/env bash
# Lean sanity tests for the mickey script.
# Tests argument parsing, usage output, and script structure.
# Does NOT require Docker â€” only validates the script itself.
set -euo pipefail

MICKEY="$(cd "$(dirname "$0")" && pwd)/mickey"
pass=0
fail=0

assert_exits() {
    local expected=$1 desc=$2; shift 2
    local actual=0
    "$@" >/dev/null 2>&1 || actual=$?
    if [[ $actual -eq $expected ]]; then
        pass=$((pass + 1)); echo "ok   - $desc"
    else
        fail=$((fail + 1)); echo "FAIL - $desc (expected exit $expected, got $actual)"
    fi
}

assert_output_matches() {
    local pattern=$1 desc=$2; shift 2
    local output
    output=$("$@" 2>&1) || true
    if echo "$output" | grep -qE "$pattern"; then
        pass=$((pass + 1)); echo "ok   - $desc"
    else
        fail=$((fail + 1)); echo "FAIL - $desc (output missing /$pattern/)"
    fi
}

# -- Script structure --
assert_exits 0 "script passes bash -n syntax check" bash -n "$MICKEY"

# -- No args --
assert_exits 1 "no args exits 1" "$MICKEY"
assert_output_matches "^Usage:" "no args shows usage" "$MICKEY"

# -- Unknown command --
assert_exits 1 "unknown command exits 1" "$MICKEY" badcmd
assert_output_matches "^Usage:" "unknown command shows usage" "$MICKEY" badcmd

# -- hire: missing name --
assert_exits 1 "hire without name exits 1" "$MICKEY" hire
assert_output_matches "mickey hire" "hire without name shows correct usage" "$MICKEY" hire

# -- whip: argument parsing --
assert_exits 1 "whip --model without value exits 1" "$MICKEY" whip --model
assert_exits 1 "whip -j without value exits 1" "$MICKEY" whip -j

# -- sh: missing name --
assert_exits 1 "sh without name exits 1" "$MICKEY" sh
assert_output_matches "mickey sh" "sh without name shows correct usage" "$MICKEY" sh

# -- fire: missing name --
assert_exits 1 "fire without name exits 1" "$MICKEY" fire
assert_output_matches "mickey fire" "fire without name shows correct usage" "$MICKEY" fire

# -- Agent rules content --
assert_exits 0 "AGENT_RULES variable is defined" grep -q "^AGENT_RULES=" "$MICKEY"
assert_exits 0 "agent rules contain workspace layout" grep -q "Workspace layout" "$MICKEY"
assert_exits 0 "agent rules contain producing output" grep -q "Producing output" "$MICKEY"
assert_exits 0 "agent rules contain sanity test requirement" grep -q "make test" "$MICKEY"
assert_exits 0 "agent rules contain wip directory" grep -q 'wip/' "$MICKEY"
assert_exits 0 "agent rules contain deployment awareness" grep -q "Deployment awareness" "$MICKEY"
assert_exits 0 "agent rules do NOT contain review process" bash -c "! grep -q 'Reviewing patches' '$MICKEY'"
assert_exits 0 "no patch/ directory references in agent rules" bash -c "! grep -q 'WORKSPACE_DIR/patch/' '$MICKEY'"

# -- Usage text --
assert_output_matches "whip" "usage mentions whip command" "$MICKEY"
assert_output_matches "am" "usage mentions am command" "$MICKEY"
assert_output_matches "wip/" "usage mentions wip directory" "$MICKEY"

echo ""
echo "$((pass + fail)) tests, $pass passed, $fail failed"
[[ $fail -eq 0 ]]
